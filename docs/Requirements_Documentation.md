# 门窗订单管理系统 - 需求规格说明书 (PRD)

## 1. 引言

### 1.1 编写目的
本文档旨在明确“门窗订单管理系统”的功能需求、非功能需求及数据要求，作为开发、测试和验收的依据。

### 1.2 适用范围
本系统适用于中小型门窗定制企业，涵盖订单管理、人员管理、基础数据维护等模块。

## 2. 角色与权限需求

系统需支持基于角色的访问控制 (RBAC)，定义以下角色：

*   **ADMIN (管理员)**：
    *   拥有所有模块的增删改查权限。
    *   接收所有关键业务通知。
*   **SALES (销售员)**：
    *   仅拥有“订单管理”模块的部分权限（新增、查看/修改/删除**自己**的订单）。
    *   拥有“品牌管理”的查看权限。
*   **INSTALLER (安装师傅)**：
    *   拥有查看分配给自己订单的权限。
    *   拥有更新订单“安装进度”的权限。

## 3. 功能需求

### 3.1 用户与认证 (User & Auth)
*   **FR-001 登录**：支持用户名/密码登录，返回JWT Token。
*   **FR-002 密码加密**：用户密码需加密存储（如BCrypt）。
*   **FR-003 用户管理**：管理员可创建用户并分配角色（Admin/Sales/Installer）。

### 3.2 订单管理 (Order Management)
*   **FR-004 订单创建**：
    *   输入项：客户姓名、电话、地址（省市区+详细）、品牌（下拉选择）、尺寸（宽/高）、价格、是否复尺。
    *   初始状态：订单状态默认为`SUBMITTED`，生产/安装进度默认为`WAITING`。
    *   系统自动生成唯一订单号（Snowflake算法）。
*   **FR-005 订单列表与查询**：
    *   支持分页查询。
    *   支持按订单号、客户姓名、电话、状态筛选。
    *   权限控制：销售只能看到自己的订单。
*   **FR-006 订单更新**：
    *   支持修改订单详情。
    *   **业务规则校验**：
        *   订单`安装进度`或`生产进度`为`FINISHED`（已完成）时，禁止修改订单信息。
        *   **进度流转限制**：必须`生产进度` = `FINISHED`后，`安装进度`才能流转为`INSTALLING`或`FINISHED`。
*   **FR-007 订单删除**：
    *   仅支持逻辑删除 (`is_deleted`)。
    *   销售只能删除自己的订单。

### 3.3 基础数据管理 (Base Data)
*   **FR-008 品牌管理**：管理员可增删改查窗户品牌（Brand），名称需唯一。

### 3.4 消息通知 (Notifications)
*   **FR-009 实时通知**：
    *   销售创建订单 -> 通知管理员。
    *   订单进度更新（生产/安装） -> 通知管理员。
    *   技术实现：WebSocket 推送。

### 3.5 系统监控 (Monitor)
*   **FR-010 操作日志**：系统需自动记录用户的敏感操作（模块、方法、参数、IP、时间）。

### 3.6 售后管理 (After Sales)
*   **FR-011 售后申请**：
    *   支持基于已有订单发起售后，自动回填客户及订单基础信息。
    *   必填项：问题描述、期望上门时间。
*   **FR-012 工单处理**：
    *   状态流转：`PENDING` (待处理) -> `ASSIGNED` (已指派) -> `PROCESSING` (处理中) -> `COMPLETED` (已完成) / `CANCELLED` (已取消)。
    *   处理操作：管理员可指派安装师傅，录入维修结果和费用。
    *   权限：管理员可指派，被指派的师傅可更新处理状态。

### 3.7 客户管理 (Customer Management)
*   **FR-013 客户档案**：
    *   核心字段：姓名、电话 (UK)、地址、备注、创建时间。
    *   统计指标：关联订单数、累计消费金额。
*   **FR-014 自动关联**：
    *   创建订单时，若手机号已存在，自动关联至现有客户并更新地址。
    *   若手机号不存在，自动创建新客户档案。
*   **FR-015 客户视图**：
    *   支持查看单一客户名下的所有历史订单列表。

### 3.8 复尺管理 (Re-measurement Management)
*   **FR-016 任务指派**：
    *   销售/管理员可为订单指派复尺任务给安装师傅（或专门测量员）。
    *   前置条件：订单已创建。
*   **FR-017 结果提交**：
    *   师傅录入精确宽、高，上传手绘图URL、现场照片列表。
    *   提交后，任务状态更新为`COMPLETED`，订单标记为`is_remeasured=true`，并更新订单宽/高。

## 4. 数据需求

### 4.1 核心实体模型
*   **WindowOrder (订单)**
    *   核心字段：`order_no` (UK), `customer_id` (FK), `customer_name`, `address`, `brand`, `width`, `height`, `install_progress`, `production_progress`.
    *   关联：`salesperson_id` (User), `installer_id` (User), `customer_id` (Customer).
*   **Customer (客户)**
    *   核心字段：`name`, `phone` (UK), `address`, `remark`.
*   **AfterSalesOrder (售后工单)**
    *   核心字段：`code` (UK), `order_id` (FK), `issue_description`, `status`, `handler_id`, `result`, `fee`.
*   **SysUser (用户)**
    *   字段：`username`, `password`, `role`.
*   **Brand (品牌)**
    *   字段：`name` (UK).
*   **RemeasureTask (复尺任务)**
    *   核心字段：`order_id` (FK), `assignee_id` (FK), `status`, `precise_width`, `precise_height`, `sketch_url`, `site_photos`.

## 5. 非功能需求 (NFR)

### 5.1 安全性
*   API 接口需通过 JWT 进行身份验证。
*   关键操作（如删除）需进行后端权限校验，不能仅依赖前端隐藏按钮。

### 5.2 性能
*   列表查询需支持分页，避免全量加载。
*   数据库索引优化：针对 `order_no`, `user_id`, `salesperson_id` 等高频查询字段建立索引。

### 5.3 易用性
*   状态显示需本地化（如显示“待生产”而非“WAITING”）。
*   错误提示需友好（如“订单未生产完成，无法安装”）。
